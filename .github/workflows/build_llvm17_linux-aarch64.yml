name: Build LLVM17

on:
  workflow_dispatch:
  push:
    branches: [llvm-17.0.6rel]

jobs:
  build_x86_64:
    runs-on: ubuntu-latest
    env:
      GITHUB_ACCESS_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4.1.6
        with:
          ref: "llvm-17.0.6rel"
          submodules: "recursive"

      - name: Cache CMake and Ninja
        uses: actions/cache@v3
        with:
          path: |
            /usr/local/bin/cmake
            /usr/local/bin/ninja
          key: ${{ runner.os }}-cmake-ninja

      - name: Setup dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build gcc g++

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build for linux-x86_64
        run: |
          mkdir build-x86_64
          cd build-x86_64
          cmake -G Ninja -DCMAKE_SYSTEM_NAME=Linux -DCMAKE_SYSTEM_PROCESSOR=x86_64 \
                -DCMAKE_BUILD_TYPE=Release \
                -DLLVM_ENABLE_PROJECTS="clang" \
                -DLLVM_TARGETS_TO_BUILD="X86" \
                -DLLVM_ENABLE_ZSTD=OFF \
                -DLLVM_INCLUDE_TESTS=OFF \
                -DLLVM_INCLUDE_EXAMPLES=OFF \
                -DLLVM_INCLUDE_UTILS=OFF \
                -DLLVM_INCLUDE_BENCHMARKS=OFF \
                -DLLVM_BUILD_TOOLS=OFF ../llvm
          ninja -j16

      - name: Verify Build Output
        run: |
          ls -lh build-x86_64/bin

      - name: Package Entire Build Directory
        run: |
          tar -czvf Hikari_LLVM17.0.6_Linux-x86_64.tar.gz -C build-x86_64 .

      - name: Upload Entire Build Artifact
        uses: actions/upload-artifact@v4.3.3
        with:
          name: Hikari_LLVM17.0.6_Linux-x86_64
          path: Hikari_LLVM17.0.6_Linux-x86_64.tar.gz
